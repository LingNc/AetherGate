# 项目代号：Aether Gate (以太之门) - 完整开发文档 (Master)

版本: 6.0 (Final Comprehensive)

目标平台: Paper 1.21.4+ (Java 21)

项目类型: 沉浸式 RPG 传送系统 + 自定义方块机制

核心依赖: ProtocolLib (可选，用于更精细的发包与特效), Paper API

Namespace: aether_gate (指令别名: charm)

# 第一部分：资源包 (Resource Pack)

**设计理念:** 极简主义。绝大部分视觉效果由服务端代码实现，资源包仅负责核心方块素材（不再依赖白屏贴图 / 头盔模型）。

## 1. 资产清单 (Assets)

### 1.1 目录结构

**Namespace:** `aether_gate`

```
assets/
└── aether_gate/
    ├── textures/
    │   └── block/
    │       └── ender_pearl_block.png  (末影珍珠块：深蓝绿色，漩涡纹理，类似黑曜石质感)
    └── models/
        ├── block/
        │   └── ender_pearl_block.json (方块模型)
        └── item/
            └── ender_pearl_block.json (物品形式模型)
```

## 2. 详细配置说明 (适配 1.21.4 Item Model)

### 2.1 末影珍珠块 (Ender Pearl Block)

这是一个自定义方块，需通过 `CustomModelData` 或 1.21.4 的 `item_model` 映射到原版物品上（建议使用 `MUSHROOM_STEM` 或 `NOTE_BLOCK` 作为基底，或者直接由插件通过 ItemDisplay 渲染）。

-   **贴图:** `textures/block/ender_pearl_block.png`

-   **模型 (`models/block/ender_pearl_block.json`):**

    ```
    {
      "parent": "minecraft:block/cube_all",
      "textures": { "all": "aether_gate:block/ender_pearl_block" }
    }
    ```

-   **物品模型 (`models/item/ender_pearl_block.json`):**

    ```
    { "parent": "aether_gate:block/ender_pearl_block" }
    ```

### 2.2 白屏视觉效果 (Particle Whiteout)

不再使用头盔 + 贴图的方式遮挡视野，而是完全通过 **白色粒子** 叠加来实现“视野被淹没成白屏”的效果。

-   **实现思路:**
        -   使用统一的白色粒子（推荐：`Particle.END_ROD` 或 `Particle.DUST` 设置为白色），在玩家视野附近以多层环/云的形式不断生成；
        -   随时间增加粒子密度与覆盖范围，使玩家逐渐“看不清周围”，直至接近纯白；
        -   粒子总量要 **严格控制**，以“刚好遮挡视线为主，不追求真实全白”，避免客户端掉帧。
-   **性能与上限:**
        -   以每 tick / 每 2 tick 为频率，小批量发射粒子；
        -   单个玩家身上的粒子发射速率控制在安全阈值（例如 < 150 粒子 / tick，具体实现时再压测）；
        -   以“环绕玩家头部的球壳 / 环”的结构为主，而不是在大范围内乱撒，减少无意义粒子。
-   **美术风格:**
        -   所有粒子均使用 **白色**（或接近白色的微偏蓝/偏青），统一风格；
        -   粒子半径从玩家脚下 SGA 符文圈起步，逐步向上包裹到视线高度；
        -   可以适当加入极少量向上漂浮的“白色流光”粒子，增强“数字化 / 以太化”的感觉，但仍保持低密度。

# 第二部分：核心插件 (Core Plugin)

## 1. 新增物品与方块

### 1.1 末影珍珠块 (Ender Pearl Block)

-   **物品 ID:** `aether_gate:ender_pearl_block`
-   **功能定义:** 高密度珍珠存储单元 / 传送消耗品。
-   **物理材质模拟:**
    -   **基底:** 建议使用 `MUSHROOM_STEM` (蘑菇柄) 并锁定其 block state，或者监听 `NoteBlock`。
    -   **硬度:** 50 (同黑曜石，防手撸)。
    -   **爆炸抗性:** 1200 (同黑曜石，防爆)。
-   **挖掘掉落:**
    -   **精准采集 (Silk Touch):** 掉落 `末影珍珠块` x1。
    -   **普通挖掘:** 掉落 `末影珍珠` x9 (防止刷物品bug，保持守恒)。
-   **合成配方 (9x9 Storage):**
    -   **合成 (9 -> 1):** 3x3 填满 `ENDER_PEARL` -> 1 `ender_pearl_block`。
    -   **分解 (1 -> 9):** 1 `ender_pearl_block` -> 9 `ENDER_PEARL` (无序)。

### 1.2 特殊交互

-   **蠹虫转化:** 蠹虫接触方块 -> 80% 变末影螨，20% 钻入/无视。
-   **紫颂果传送:** 食用紫颂果 -> 优先传送到半径 32 格内的末影珍珠块上方。

### 1.3 世界锚点 (World Anchor) - 核心方块

-   **原名:** 磁石 (Lodestone)
-   **物品 ID:** `aether_gate:world_anchor` (修改 NBT 显示名称)
-   **显示名称:** `§b§l世界锚点`
-   **功能:** 祭坛的核心控制单元。
-   **获取配方 (Hardcore):**
    -   **Row 1:** [钻石] [末影珍珠块] [钻石]
    -   **Row 2:** [青金石块] [雕纹石砖] [青金石块]
    -   **Row 3:** [钻石] [哭泣黑曜石] [钻石]
    -   **产出:** 世界锚点 x1

## 2. 祭坛系统 (The Altar System)

### 2.1 结构定义 (Multiblock / The 5x5 Pyramid)

**祭坛全服共享**。结构以世界锚点为中心 `(0,0,0)`。

#### 2.1.1 建造配方 (Structure Recipe)

玩家需要先搭建一个多方块结构，整体为 5x5 的多层金字塔：

-   **核心:** `LODESTONE` (磁石 / 世界锚点) - 放置在中心上层。其正下方中心方块是一个 **木桶 (Barrel)**，作为基础容器。
-   **底座 (Layer -2, y=-2, 地基层):**
    -   以桶所在坐标为中心的 5x5 区域全部铺满 **石砖类方块 (Bricks)**，记作 A。
    -   允许的 A 类型包括但不限于：`QUARTZ_BRICKS`, `POLISHED_BLACKSTONE_BRICKS`, `NETHER_BRICKS`, `RED_NETHER_BRICKS`, `DEEPSLATE_BRICKS`, `DEEPSLATE_TILES` 等。
-   **容器层 (Layer -1, y=-1):**
    -   中心 `(0,0)`: **木桶 (Barrel)** [核心容器 - 必需]，记作 C。
    -   内圈 `(±1 环)`: 放置与 A 材质匹配的 **楼梯 (Stairs)**，记作 B，楼梯朝向中心。
    -   外圈 `(±2 环)`: 同样是材质匹配的楼梯 B，朝向中心，形成同心阶梯状结构。
    -   四个角 `(±2, ±2)`: 放置 A 类型的实心砖方块，用于支撑上方柱子。

整体示意（仅作说明，不参与渲染）：

第一层 (y=-2):
AAAAA
AAAAA
AAAAA
AAAAA
AAAAA

第二层 (y=-1):
AB_BA
B___B
__C__
B___B
AB_BA

第三层 (y=0):
A___A
_____
__W__
_____
A___A

第四层 (y=1):
A___A
_____
_____
_____
A___A

第四层 (y=2):
P___P
_____
_____
_____
P___P

其中：A 为砖块，B 为对应材质楼梯，C 为木桶，P 为光源方块(铁粒灯,铜粒灯等)，W 为世界锚点。

-   **核心层 (Layer 0, y=0):**
    -   中心 `(0,0)`: **世界锚点 (World Anchor / Lodestone)** [核心]。
    -   四个角 `(±2, ±2)`: 由下层角落砖块支撑的 **柱子 (Pillars)**，柱子顶端必须放置光源方块。
    -   其余位置留空 (空气)，不做强制要求。
-   **上层 (Layer 1, y=1, 核心上层):**
    -   中心 `(0,0)`: 激活后生成一个 **ITEM_DISPLAY (潮涌核心模型)**，悬浮在世界锚点上方。
    -   同时生成一个虚拟光源，亮度 15，用于营造圣堂感。
    -   在潮涌核心周围持续生成 **多层 SGA 字符粒子环**：若干个半径不同、高度不同的同心圆环，缓慢自转、轻微上下浮动，营造神圣 / 仪式感的“银河文字光环”。
    -   参考附魔台的 ENCHANT 粒子效果，在核心附近不断有 **SGA 字符粒子向外飘散**：
        -   粒子生成位置在核心附近最为密集，越靠近外圈越稀疏；
        -   运动方向整体由内向外、略微上升，好像“文字由核心溢出、向四周流淌”；
        -   相比原版附魔台从书架吸向中心，这里视觉语言是 **从核心向外辐射** 的 SGA 流光。

**材质与匹配规则:**

-   **A (Bricks):** 必须是预设允许列表中的某一种砖块类型。
-   **B (Stairs):** 必须使用与 A 材质对应的楼梯（例如使用 `NETHER_BRICKS` 作为 A，则 B 只能是 `NETHER_BRICK_STAIRS`）。
-   **光源:** 允许 `LANTERN`, `SOUL_LANTERN`, `GLOWSTONE`, `SEA_LANTERN`, `FROG_LIGHT` 等高亮度光源。
-   **匹配策略:** 为了避免玩家乱搭导致逻辑复杂，建议结构检测逻辑采取 **严格匹配**：
    -   每一层、每一格都按照上述规则硬性校验；
    -   不允许混搭不同 A 材质（整座祭坛的砖 & 楼梯材质必须一致）。

#### 2.1.2 容器与连接范围

-   **有效容器范围:** 以祭坛核心（世界锚点）为中心，覆盖自底座所在层起、向上 5 格的 **5x5x5 立方体范围**。
-   **支持容器类型:**
    -   `BARREL` (木桶)
    -   `CHEST` (箱子)
    -   `TRAPPED_CHEST` (陷阱箱)
    -   各色 `SHULKER_BOX` (潜影盒)
-   **优先级规则:** 在后续扣费算法中，所有木桶的优先级高于其他容器：
    -   先检查范围内的 **木桶**；
    -   再检查其他容器 (箱子 / 潜影盒)。

#### 2.1.3 容器与扣费逻辑 (简要预览)

完整扣费流程见下文 2.3.1，这里只强调与结构绑定的部分：

1.  **优先级 1 (核心木桶 - 散装):** 检查核心木桶内是否有 `ENDER_PEARL` -> 扣除 1 个。
2.  **优先级 2 (核心木桶 - 块):** 检查核心木桶内是否有 `ender_pearl_block` -> 扣除 1 个块 -> 在该格子(或空位)生成 8 个珍珠 (自动找零)。
3.  **优先级 3 (扩展范围容器):** 检查同一 5x5x5 范围内其他容器 (箱子 / 潜影盒等) -> 同上逻辑（先散装，再块）。
4.  **优先级 4 (玩家背包):** 如果所有容器都不足，再检查玩家背包。

### 2.2 激活、炸膛与生命周期 (Lifecycle)

#### 2.2.1 状态定义

-   **ACTIVE (激活):** `charges > 0` 且结构完整。书本可见，可传送。
-   **DORMANT (荒废/枯竭):** `charges == 0`。书本移除，不可传送，数据保留。
-   **DESTROYED (破坏):** 世界锚点被挖。数据删除。

#### 2.2.2 激活检测与炸膛机制 (Risk & Reward)

-   **触发:** 玩家手持 **矿物块** 右键未激活/荒废的“世界锚点”。
-   **检测流程:**
    1.  扫描 5x5x3 区域方块是否严格匹配结构。
    2.  **如果结构完整:** -> 进入 **[激活流程]**。
    3.  **如果结构不完整** (缺底座、缺光源、缺柱子等): -> 触发 **[炸膛 (Backfire)]**。
-   **[激活流程] (Success):**
    1.  进入充能流程 (见下文充能规则)。
    2.  **数据库更新:** 标记有效，加入全服列表。
    3.  生成视觉实体 (潮涌核心) 和光照，播放 `BLOCK_RESPAWN_ANCHOR_CHARGE`。
-   **[炸膛流程] (Failure - The Backfire):**
    1.  **爆炸伤害:** 在锚点位置产生威力 10.0 的爆炸 (伤害实体，`blockDamage=false`)。
    2.  **视觉特效:** 向外快速扩散的红色/橙色粒子圆环 (Shockwave) + 巨响 `ENTITY_GENERIC_EXPLODE`。
    3.  **世界锚点破碎:** 中心锚点方块直接设为 AIR。
    4.  **掉落惩罚:** 仅掉落 钻石x4 + 哭泣黑曜石x1。**原配方中的珍珠块、青金石、石砖全部损毁不退还。**
    5.  **提示:** "祭坛结构不稳定，能量失控炸膛了！"

#### 2.2.3 充能规则 (Fuel & Durability)

祭坛有 **“剩余充能次数” (Charges)**。每次传送消耗 1 次充能。当充能归零，祭坛虽然不会立刻爆炸，但无法传送，直到补充燃料。

-   **补充规则:** 手持矿物块右键已激活（或荒废）的祭坛。
-   **数值表:**
    -   `COPPER_BLOCK`: +3 次
    -   `IRON_BLOCK`: +6 次
    -   `GOLD_BLOCK`: +12 次
    -   `LAPIS_BLOCK`: +20 次
    -   `DIAMOND_BLOCK`: +30 次
    -   `NETHERITE_BLOCK`: +100 次
    -   `NETHER_STAR`: **永久激活** (无需再消耗充能，且UI显示 ∞)。
    -   *注意：已经投入的矿物块不退还。*

#### 2.2.4 枯竭与崩塌 (Active -> Dormant)

-   **触发:** 传送消耗导致 `charges` 归零。
-   **逻辑:**
    1.  **数据库更新:** 标记为“荒废”，**立即从全服列表移除**。
    2.  **视觉崩塌:** 移除潮涌核心，移除光照。
    3.  **结构破坏:** **强制破坏** 四个角柱子上的光源方块 (播放破碎特效，不掉落)。
    4.  **粒子内爆:** 原本环绕的银河字符粒子瞬间向中心急剧收缩，然后炸开消失。
    5.  **音效:** 播放高音量的破坏音效 `ENTITY_WITHER_BREAK_BLOCK` (Pitch 0.5)。

## 3. 传送仪式流程 (The Ritual)

**全程保护:** Phase 1 & 2 期间玩家处于 **无敌状态** (免疫 EntityDamage)，防止打断。

### Phase 1: 预热与共鸣 (0s - 3s)

-   **锁定:** 禁止移动/跳跃/开包。
-   **白屏渐变 (纯粒子版，全部使用 SGA 粒子):**
    -   `0.0s`: 开始，在玩家脚下与身体周围少量生成 SGA 符文粒子（脚下符文圈 + 稀疏上升字符），此时仍能清晰看见环境；
    -   `0.5s - 1.5s`: 逐步提高粒子密度，SGA 字符粒子圈开始升高到腰部、胸口高度，视野略微发白/发亮，但仍能辨认轮廓；
    -   `1.5s - 2.5s`: 在玩家头部周围构建多层 SGA 字符“雾墙 / 壳”，字符沿着圆环/螺旋轨迹缓慢旋转，玩家大部分时间只能看到一片由 SGA 字符构成的白色/浅色光雾；
    -   `~2.5s`: 粒子密度达到峰值——不用做到完全像贴图那样 100% 纯白，但在正常 FOV 下 **基本看不到场景细节，只能看到密集的 SGA 字符光带** 即可。
-   **粒子演出细节 (全部使用白色系 SGA 粒子):**
    -   **螺旋光环 (Rising Rings):** 从玩家脚下生成由 SGA 字符组成的白色粒子圈，这个圈会一直保留。随后在它上方不断生成新的一层圈，层层叠加并旋转上升（螺旋塔状），直至包裹玩家视线高度；
    -   **SGA 符文圈:** 同时，脚下原有的 SGA 符文圈保持旋转，且其 **密度和速度** 随时间指数增加，但总量仍要控制在不会明显卡顿的水平；
    -   粒子全部选用白色 / 浅色系，并统一为“SGA 字符粒子”风格，避免使用与主题无关的粒子类型。

### Phase 2: 瞬移与分解 (3s 瞬间)

-   **执行扣费:** 祭坛耐久 -1 (如归零触发枯竭)，扣除 1 珍珠。
-   **出发点特效 (SGA Explosion):**
    -   玩家消失瞬间，之前积累的所有 SGA 字符粒子圈瞬间向外 **爆炸爆开** 并消失（由 SGA 字符组成的白色冲击波），象征能量释放；
    -   冲击波形态可以是多层向外扩散的圆环 / 球壳，全部由 SGA 字符粒子构成，保持统一的“文字能量”视觉语言。
-   **传送:**
    -   目标点: 目标祭坛底座范围 (5x5) 内的 **随机安全位置** (y+1, 站在底座上)。
    -   **避免重叠:** 确保随机到的坐标没有其他玩家。
-   **音效:** `ENTITY_LIGHTNING_BOLT_THUNDER` (带混响)。

### Phase 3: 降临与重组 (3s - 4s)

-   **目的地预热 (Pre-Arrival):**
    -   在玩家到达前 0.5s，目标位置生成 **从上至下** 快速降落的 SGA 字符圆形粒子扫描圈（字符如同数据流从天空写入地面，象征数据重组 / 重构身体）。
-   **玩家出现:** 实体渲染出现，环绕玩家的 SGA 字符圈向身体中心急剧收缩并消失，仿佛字符重新编译成实体。
-    **视觉闪电:** 在 **出发点** 和 **到达点** 均生成无伤害的视觉闪电。(在传送瞬间产生)
-    **冲击波:**
    -   到达点半径 5 格内。
    -   排除: 玩家本人、驯服的宠物 (Tameable)。
    -   效果: 击退向量以中心点为中心向四周击退 (Vector away from center) + 2点伤害。
-   **视野恢复 (倒序，依旧使用 SGA 粒子):**
    -   `3.0s`: 目的地附近仍有较高密度的 SGA 字符粒子，玩家刚到达时视野依旧被字符光带淹没；
    -   `3.2s`: 减少粒子发射频率与数量，只保留中等密度的 SGA 粒子环绕玩家；
    -   `3.5s`: 再次削减粒子，仅在脚下 / 身边留下少量残留的 SGA 字符粒子，仿佛残留的数据流；
    -   `3.8s`: 停止额外 SGA 粒子生成，视野完全恢复正常，仅保留必要的环境粒子效果。
-   **解锁:** 移除无敌，恢复行动。

## 4. 数据存储与指令

### 4.1 数据结构 (SQLite)

-   `waypoints` 表:
    -   `uuid`: ID
    -   `name`: 祭坛名称
    -   `location`: world, x, y, z
    -   `charges`: int (剩余次数)
    -   `owner`: player_uuid
    -   *查询逻辑: 仅返回 `charges > 0` 的记录。*

### 4.2 交互界面 (Written Book GUI)

-   **触发:** 右键激活的锚点。
-   **动态列表:** 实时读取数据库，不显示已枯竭/被破坏的祭坛。
-   **交互:** 点击 `[ > 目的地名称 ]` 触发传送。

### 4.2 命名与管理



-   **命名:** 手持 `NAME_TAG` (命名牌) 右键祭坛核心。

    -   消耗 1 个命名牌。

    -   更新数据库中的 `name`。

-   **指令:**

    -   `/charm list`: 列出自己的祭坛。

    -   `/charm give_block`: 获取末影珍珠块 (管理员)。

    -   `/charm reload`: 重载配置。



## 5. 开发优先级 (Roadmap)

1.  **核心物品:** 实现末影珍珠块 (9合1、掉落、合成) 和 世界锚点 (Hardcore配方)。
2.  **结构系统:** 实现 5x5 多层结构检测算法、炸膛逻辑、激活/枯竭逻辑。
3.  **传送核心:** 实现无敌、白屏发包、随机坐标传送、智能扣费。
4.  **视觉特效:** 实现“从上至下扫描圈”、“粒子内爆”、“SGA环绕”等复杂粒子效果。
5.  **GUI:** 实现动态书本列表。